# US-V1-03.3 : Génération Apple Wallet

| Métadonnée | Valeur |
|------------|--------|
| **ID** | US-V1-03.3 |
| **Epic** | E-V1-03 : Cartes adhérent |
| **Milestone** | V1.0 |
| **Priorité** | P1 |
| **PRD** | [prd-faatere-v1.md](../../prd-faatere-v1.md) |

---

## User Story

**En tant que** gestionnaire,
**Je veux** générer un pass Apple Wallet,
**Afin que** l'adhérent ait sa carte sur son iPhone.

---

## Critères d'acceptance

- [ ] Endpoint GET /members/:id/card/apple-wallet
- [ ] Vérification hasPaid === true
- [ ] Retourne fichier .pkpass
- [ ] Pass type : PKPassTypeGeneric
- [ ] Contenu : nom, photo (investigation requise), numéro

---

## Configuration Apple Wallet

```typescript
// Configuration requise
APPLE_PASS_TYPE_IDENTIFIER=pass.pf.faatere.member
APPLE_TEAM_IDENTIFIER=xxx
APPLE_PASS_CERTIFICATE=xxx // .p12 ou .pem
APPLE_PASS_PRIVATE_KEY=xxx
```

---

## Structure du Pass (pass.json)

```json
{
  "formatVersion": 1,
  "passTypeIdentifier": "pass.pf.faatere.member",
  "serialNumber": "{memberId}",
  "teamIdentifier": "XXXXXXXXXX",
  "organizationName": "Faatere",
  "description": "Carte adhérent Faatere",
  "logoText": "FAATERE",
  "foregroundColor": "rgb(255, 255, 255)",
  "backgroundColor": "rgb(30, 64, 175)",
  "generic": {
    "primaryFields": [
      {
        "key": "name",
        "label": "ADHÉRENT",
        "value": "{firstName} {lastName}"
      }
    ],
    "secondaryFields": [
      {
        "key": "memberNumber",
        "label": "N° ADHÉRENT",
        "value": "{memberNumber}"
      },
      {
        "key": "tomite",
        "label": "TOMITÉ",
        "value": "{tomiteName}"
      }
    ],
    "backFields": [
      {
        "key": "memberSince",
        "label": "Membre depuis",
        "value": "{membershipDate}"
      }
    ]
  },
  "barcode": {
    "message": "https://faatere.pf/verify/{memberId}",
    "format": "PKBarcodeFormatQR",
    "messageEncoding": "iso-8859-1"
  }
}
```

---

## Tâches techniques

### Backend

- [ ] Obtenir Apple Developer Account
- [ ] Créer Pass Type ID
- [ ] Générer certificat de signature
- [ ] Installer passkit-generator ou pkpass library
- [ ] Implémenter génération du .pkpass
- [ ] Signer le pass
- [ ] Retourner le fichier avec Content-Type: application/vnd.apple.pkpass

### Frontend

- [ ] Bouton "Ajouter à Apple Wallet"
- [ ] Téléchargement du fichier .pkpass
- [ ] Icône Apple Wallet officielle

---

## Dépendances

- US-V1-03.1 : Génération carte PDF

---

## Notes

Apple Wallet nécessite un compte Apple Developer ($99/an). Les passes doivent être signés avec un certificat valide.
