# US-V1-04.1 : Logging des mutations

| Métadonnée | Valeur |
|------------|--------|
| **ID** | US-V1-04.1 |
| **Epic** | E-V1-04 : Audit |
| **Milestone** | V1.0 |
| **Priorité** | P0 |
| **PRD** | [prd-faatere-v1.md](../../prd-faatere-v1.md) |

---

## User Story

**En tant que** système,
**Je veux** logger toutes les mutations sur les adhérents,
**Afin d'** assurer la traçabilité.

---

## Critères d'acceptance

- [ ] Intercepteur NestJS pour mutations Member
- [ ] Entité AuditLog créée
- [ ] Actions loguées : CREATE, UPDATE, DELETE, TRANSFER
- [ ] Données : userId, entityId, action, changes (avant/après), timestamp, tomiteId

---

## Schéma AuditLog

```typescript
interface AuditLog {
  id: UUID;
  entityType: 'MEMBER' | 'TOMITE' | 'USER';
  entityId: UUID;
  action: 'CREATE' | 'UPDATE' | 'DELETE' | 'TRANSFER';
  userId: UUID;
  tomiteId: UUID;
  changes: {
    before: Record<string, any>;
    after: Record<string, any>;
  };
  metadata: Record<string, any>; // Ex: targetTomiteId pour TRANSFER
  createdAt: timestamp;
}
```

---

## Tâches techniques

### Backend

- [ ] Créer entité AuditLog
- [ ] Créer AuditService avec méthode log
- [ ] Créer intercepteur AuditInterceptor
- [ ] Décorateur @Audited() pour les méthodes à tracer
- [ ] Capturer l'état avant/après pour les updates
- [ ] Stocker les logs en base de données

### Exemple d'utilisation

```typescript
@Audited()
@Patch(':id')
async updateMember(@Param('id') id: string, @Body() dto: UpdateMemberDto) {
  return this.membersService.update(id, dto);
}
```

---

## Dépendances

- US-MVP-04.1 : Créer un adhérent

---

## Notes

Les logs d'audit sont essentiels pour la conformité et la résolution de problèmes. Ils ne doivent jamais être supprimés.
