# US-V11-03.1 : Sync automatique

| Métadonnée | Valeur |
|------------|--------|
| **ID** | US-V11-03.1 |
| **Epic** | E-V11-03 : Synchronisation |
| **Milestone** | V1.1 |
| **Priorité** | P0 |
| **PRD** | [prd-faatere-v1.md](../../prd-faatere-v1.md) |

---

## User Story

**En tant que** app mobile,
**Je veux** synchroniser automatiquement à la reconnexion,
**Afin de** mettre à jour le serveur.

---

## Critères d'acceptance

- [ ] Trigger auto à la reconnexion
- [ ] Upload des mutations pending
- [ ] Download des nouvelles données serveur
- [ ] Ordre : créations → modifications → suppressions

---

## Flux de synchronisation

```
┌─────────────────────────────────────────────┐
│ 1. Détection reconnexion                    │
│    ↓                                        │
│ 2. Upload mutations locales                 │
│    - CREATE (avec photos)                   │
│    - UPDATE                                 │
│    - DELETE                                 │
│    ↓                                        │
│ 3. Résoudre conflits éventuels              │
│    ↓                                        │
│ 4. Download updates serveur                 │
│    - Nouveaux adhérents                     │
│    - Modifications                          │
│    - Suppressions                           │
│    ↓                                        │
│ 5. Mettre à jour base locale                │
│    ↓                                        │
│ 6. Notifier l'utilisateur                   │
└─────────────────────────────────────────────┘
```

---

## Interface pendant sync

```
┌─────────────────────────────┐
│ ✓ Connexion rétablie        │
│   Synchronisation...        │
│   ████████░░░░ 3/5          │
├─────────────────────────────┤
```

---

## Tâches techniques

- [ ] Créer SyncService
- [ ] Implémenter upload des mutations
- [ ] Gérer l'upload des photos
- [ ] Implémenter download des updates
- [ ] Mettre à jour les numéros d'adhérent
- [ ] Supprimer les mutations synchronisées
- [ ] Gérer les erreurs et retries

---

## Endpoint de sync

```typescript
// POST /sync
interface SyncRequest {
  mutations: PendingMutation[];
  lastSyncTimestamp: string;
}

interface SyncResponse {
  processedMutations: {
    localId: string;
    serverId: string;
    memberNumber: string;
    status: 'success' | 'conflict' | 'error';
    error?: string;
  }[];
  updates: {
    created: Member[];
    updated: Member[];
    deleted: string[];
  };
  serverTimestamp: string;
}
```

---

## Dépendances

- US-V11-02.2 : Détection connectivité
- US-V11-02.3 : Création adhérent offline

---

## Notes

La synchronisation doit être robuste face aux interruptions réseau pendant le processus.
