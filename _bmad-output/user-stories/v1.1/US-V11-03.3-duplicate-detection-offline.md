# US-V11-03.3 : Gestion doublons cross-tomité offline

| Métadonnée | Valeur |
|------------|--------|
| **ID** | US-V11-03.3 |
| **Epic** | E-V11-03 : Synchronisation |
| **Milestone** | V1.1 |
| **Priorité** | P1 |
| **PRD** | [prd-faatere-v1.md](../../prd-faatere-v1.md) |

---

## User Story

**En tant que** système,
**Je veux** détecter les doublons lors de la sync,
**Afin de** maintenir l'intégrité.

---

## Critères d'acceptance

- [ ] Vérification serveur lors de la sync
- [ ] Si doublon détecté : modal de résolution (comme online)
- [ ] Options : transfert, créer quand même, annuler

---

## Scénario

1. Hina crée "Moana Tetuanui" en offline (tomité Faa'a)
2. Jean a créé "Moana Tetuanui" online (tomité Papeete)
3. Hina se reconnecte → doublon détecté lors de la sync
4. Modal proposant les options

---

## Modal de résolution doublon

```
┌─────────────────────────────┐
│ ⚠️ Doublon détecté          │
├─────────────────────────────┤
│                             │
│ Moana TETUANUI existe       │
│ déjà dans le tomité         │
│ Papeete                     │
│                             │
│ ○ Demander transfert        │
│   vers mon tomité           │
│                             │
│ ○ Créer quand même          │
│   (ce sont des homonymes)   │
│                             │
│ ○ Annuler cette inscription │
│                             │
│ ┌───────────────────────┐   │
│ │      Confirmer        │   │
│ └───────────────────────┘   │
│                             │
└─────────────────────────────┘
```

---

## Tâches techniques

- [ ] Vérifier doublons côté serveur lors du sync
- [ ] Retourner info doublon dans la réponse sync
- [ ] Créer modal de résolution doublon mobile
- [ ] Implémenter les 3 options
- [ ] Mettre à jour la base locale selon le choix

---

## Réponse serveur si doublon

```typescript
interface SyncMutationResult {
  localId: string;
  status: 'success' | 'conflict' | 'duplicate' | 'error';
  duplicate?: {
    existingMemberId: string;
    existingMemberNumber: string;
    existingTomite: string;
  };
}
```

---

## Dépendances

- US-V11-03.1 : Sync automatique
- US-MVP-04.3 : Résolution de conflit doublon (logique)

---

## Notes

La gestion des doublons est identique à la version web, mais déclenchée lors de la synchronisation.
